'use strict';

// A tool that prompts the user to accept a license agreement found in <LICENSE_FILE>
// The first line of <LICENSE_FILE> must be the title of the agreement.
// Use: node accept <LICENSE_FILE>

var fs = require('fs');
var os = require('os');
var readline = require('readline');

var parse = require('./utils/parse');

function main(argv) {
  var args = argv[1] === 'debug' ? argv.slice(3) : argv.slice(2);
  var options = [];

  try {
    var cmds = args.slice(parse(args, options));
  } catch (err) {
    console.error(err.message);
    process.exit(1);
  }

  if (cmds && cmds.length != 1 || options.length > 0) {
    console.error('Usage: node accept <LICENSE_FILE>');
    process.exit(1);
  }

  var license, title;
  try {
    license = fs.readFileSync(cmds[0], {encoding: 'utf8'});
    title = license.split(/\r?\n/)[0];
  } catch (e) {
    console.error('Failed to read license file.');
    process.exit(1);
  }

  var rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  var readPrompt = 'Using this software requires accepting the ' + title + '. See ' + cmds[0] + '.\n' +
    'To read the file, press Enter. : ';

  var acceptPrompt = 'Do you accept the ' + title + '?\n' +
    'Please type \'yes\' and press Enter to accept. Type \'read\' to read again. Type \'no\' to reject. : ';

  var handleRead = function(answer) {
    console.log("\n" + license + "\n");
    rl.question(acceptPrompt, handleAccept);
  };

  var handleAccept = function(answer) {
    var ans = answer.toLowerCase().trim();
    if (ans === 'yes') {
      process.exit(0);
    } else if (ans === 'no') {
      process.exit(1);
    } else if (ans === 'read') {
      console.log("\n" + license + "\n");
    }
    rl.question(acceptPrompt, handleAccept);
  };

  rl.on('SIGINT', function() {process.exit(1);});

  rl.question(readPrompt, handleRead);
}

main(process.argv);