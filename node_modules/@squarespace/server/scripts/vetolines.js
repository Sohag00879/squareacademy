'use strict';

// A script that trims lines from a file starting with a given sequence.
// Used during npm install to clean up scripts.
// Use: node vetolines <filename> <pattern>

var fs = require('fs');

function main(argv) {
  // get args
  var args = argv.slice(2);
  var fileName = args[0];
  var pattern = args[1];
  if (!fileName || !pattern) {
    console.error('Missing arguments.');
    console.log('Usage: node vitolines <filename> <pattern>.');
    process.exit(1);
  }

  // read file
  try {
    var content = fs.readFileSync(fileName, 'utf8');
  } catch (err) {
    console.error(err.message);
    process.exit(1);
  }

  // veto matches
  var regex = new RegExp('^' + pattern || '!!UNDEF!!' + '.*$', 'gm');
  var matches = content.match(regex);
  var numlines = matches ? matches.length : 0;
  console.log('Removing '+numlines+' lines starting with \''+pattern+'\' in '+fileName);
  var edited = content.replace(regex, '');

  // write result
  try {
    fs.writeFileSync(fileName, edited);
  } catch (err) {
    console.error(err.message);
    process.exit(1);
  }
}

main(process.argv);