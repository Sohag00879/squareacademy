'use strict';

// A tool that runs a command only if given conditions are met.
// Use: node if [all|any] [options] <cmds>...
//    If omitted, the operation will be 'all'.
//    Options can be:
//    --os=<os>             OS must match one of darwin, win32 or linux.
//    --notos=<os>          OS must not match.
//    --exists=<filename>   The given file must exist.
//    --absent=<filename>   The given file doesn't exist.


var parse = require('./utils/parse');
var cond = require('./utils/conditions');
var execSafe = require('./utils/exec').execSafe;

function main(argv) {
  var args = argv[1] === 'debug' ? argv.slice(3) : argv.slice(2);
  var conditions = [];

  var operation = 'all';
  if (args.length > 0 && ['any', 'all'].indexOf(args[0].toLowerCase()) > -1) {
    operation = args[0].toLowerCase();
    args = args.slice(1);
  }

  try {
    var cmds = args.slice(parse(args, conditions));
  } catch (err) {
    console.error(err.message);
    process.exit(1);
  }

  if (!cmds || cmds.length < 1) {
    console.error('Missing or invalid arguments.');
    console.log('Usage: node if.js [all|any] [conditions] <commands>...');
    process.exit(1);
  }

  switch (operation) {
    case "all":
      cond.checkAll(conditions, function() { process.exit(0) });
      break;
    case "any":
      cond.checkAny(conditions, function() { process.exit(0) });
      break;
  }

  try {
    execSafe(cmds);
  } catch (err) {
    console.error(err.message);
    process.exit(1);
  }
}

main(process.argv);